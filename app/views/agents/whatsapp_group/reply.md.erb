<AVAILABLE_TOOLS>
## YOUR TOOLS (USE THESE EXACTLY):

- **send_reply** - use this to send your reply to the incoming message.
  - takes `text` (string).
  - in `text`, you can mention users by phone number (example: "@14153334444").
  - DO NOT output plain text as your final answer; YOU MUST call this tool to
    reply.

- **send_message_history_link** - use this to send the full message history URL.
  - sends a message containing the group's full message history URL.
  - YOU MUST USE THIS TOOL TO SEND THE LINK.
  - DO NOT send the history URL through `send_reply`.

- **load_messages_before** - scroll upward from a known anchor message.
  - takes `anchor_message_id` (string): the message ID to scroll from.
  - takes `limit` (integer): maximum number of messages to load.

- **load_messages_after** - scroll downwards from a known anchor message.
  - takes `anchor_message_id` (string): the message ID to scroll from.
  - takes `limit` (integer): maximum number of messages to load.

- **search_messages** - search for messages in the group.
  - takes `any_keywords` (array<string>): match if ANY keywords are present.
  - takes `all_keywords` (array<string>): match if ALL keywords are present.
  - `any_keywords` and `all_keywords` options are MUTUALLY EXCLUSIVE.
  - takes `any_participants` (array<string>): match if ANY participant is
    present (via LID, JID, or phone number).
  - takes `date_range` (object):
    - `from` (string): ISO-8601 range start date, i.e. "2026-01-01".
    - `to` (string): ISO-8601 range end date, i.e. "2026-01-31".
</AVAILABLE_TOOLS>


<CONTEXT>
## RECENT MESSAGE HISTORY FOR THIS GROUP:
<%- recent_messages = @message.previous_messages(limit: 6) -%>
<%- if recent_messages.any? -%>
  <%- recent_messages.reverse_each.each_with_index do |message, index| -%>
    <%- if index > 0 -%>


    <%- end -%>
### MESSAGE <%= index + 1 %>:

<%= render "agents/whatsapp_group/message", message: -%>
  <%- end -%>
<%- else -%>
(no recent messages; may have just joined group, or group is new)
<%- end -%>


> [!TIP]
>
> If you need to load more message history, you can use the
> `load_messages_before` tool, with the last message ID as the anchor.
</CONTEXT>


<INPUT>
## THE INCOMING MESSAGE YOU MUST REPLY TO:
<%= render "agents/whatsapp_group/message", message: @message -%>
</INPUT>


<ACTION_SEQUENCE>
YOU MUST read the incoming message and use the `send_reply` tool to respond.
DO NOT OUTPUT your reply message; you MUST use the provided tool.
</ACTION_SEQUENCE>


<OUTPUT_FORMAT>
after using tools, you MUST output a JSON object with the following format:
{
  "tools_used": [...names of tools used during the session...]
}
</OUTPUT_FORMAT>
