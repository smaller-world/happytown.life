name: CI

on:
  - push
  - pull_request

env:
  BUNDLE_PATH: vendor/bundle

jobs:
  scan_ruby:
    name: Scan for Ruby security issues
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Set up Ruby
        uses: jdx/mise-action@v3
        with:
          install_args: ruby
      - name: Install Ruby gems
        run: mise x -- bundle install
      - name:
          Scan for common Rails security vulnerabilities using static analysis
        run: bin/brakeman --no-pager
      - name: Scan for known security vulnerabilities in gems used
        run: bin/bundler-audit

  # TODO: Re-enable when we've fixed the security issue introduced by 'shadcn'
  # scan_js:
  #   name: Scan for JavaScript security issues
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v6
  #     - name: Set up Bun
  #       uses: jdx/mise-action@v3
  #       with:
  #         install_args: bun
  #     - name: Install Bun packages
  #       run: mise x -- bun install
  #     - name: Scan for known security vulnerabilities in packages used
  #       run: bun audit

  check:
    name: Check code issues
    runs-on: ubuntu-latest
    env:
      RUBOCOP_CACHE_ROOT: tmp/rubocop
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Set up tools
        uses: jdx/mise-action@v3
      - name: Install Ruby gems
        run: mise x -- bundle install
      - name: Install Bun packages
        run: mise x -- bun install
      - name: Prepare RuboCop cache
        uses: actions/cache@v4
        env:
          DEPENDENCIES_HASH:
            ${{ hashFiles('.ruby-version', '**/.rubocop.yml',
            '**/.rubocop_todo.yml', 'Gemfile.lock') }}
        with:
          path: ${{ env.RUBOCOP_CACHE_ROOT }}
          key:
            rubocop-${{ runner.os }}-${{ env.DEPENDENCIES_HASH }}-${{
            github.ref_name == github.event.repository.default_branch &&
            github.run_id || 'default' }}
          restore-keys: |
            rubocop-${{ runner.os }}-${{ env.DEPENDENCIES_HASH }}-
      - name: Check code issues
        run: mise check --all

  test:
    name: Run tests
    runs-on: ubuntu-latest

    env:
      RAILS_ENV: test
      DATABASE_URL: postgres://supabase_admin:postgres@localhost:5432/postgres

    services:
      postgres:
        image: postgres
        env:
          POSTGRES_USER: supabase_admin
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options:
          --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s
          --health-retries=3
      # redis:
      #   image: valkey/valkey:8
      #   ports:
      #     - 6379:6379
      #   options: --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - name: Install system packages
        run:
          sudo apt-get update && sudo apt-get install --no-install-recommends -y
          libpq-dev
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Set up tools
        uses: jdx/mise-action@v3
      - name: Install Ruby gems
        run: mise x -- bundle install
      - name: Install Bun packages
        run: mise x -- bun install
      - name: Prepare database
        run: bin/rails db:test:prepare
      - name:
          Run tests
          # RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
          # REDIS_URL: redis://localhost:6379/0
        run: mise test

  # system-test:
  #   runs-on: ubuntu-latest
  #   services:
  #     postgres:
  #       image: postgres
  #       env:
  #         POSTGRES_USER: supabase_admin
  #         POSTGRES_PASSWORD: postgres
  #       ports:
  #         - 5432:5432
  #       options:
  #         --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s
  #         --health-retries=3
  #     # redis:
  #     #   image: valkey/valkey:8
  #     #   ports:
  #     #     - 6379:6379
  #     #   options: --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5
  #   steps:
  #     - name: Install system packages
  #       run:
  #         sudo apt-get update && sudo apt-get install --no-install-recommends -y
  #         libpq-dev
  #     - name: Checkout code
  #       uses: actions/checkout@v6
  #     - name: Set up tools
  #       uses: jdx/mise-action@v3
  #     - name: Install Ruby gems
  #       run: mise x -- bundle install
  #     - name: Install Bun packages
  #       run: mise x -- bun install
  #     - name: Prepare database
  #       run: bin/rails db:test:prepare
  #     - name: Run system tests
  #       env:
  #         RAILS_ENV: test
  #         DATABASE_URL: postgres://supabase_admin:postgres@localhost:5432
  #         # RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
  #         # REDIS_URL: redis://localhost:6379/0
  #       run: bin/rails test:system
  #     - name: Keep screenshots from failed system tests
  #       uses: actions/upload-artifact@v4
  #       if: failure()
  #       with:
  #         name: screenshots
  #         path: ${{ github.workspace }}/tmp/screenshots
  #         if-no-files-found: ignore
